<div class="profile-root dark-theme">
  <mat-card class="card">

    <!-- HEADER -->
    <section class="section header-section">
      <div class="header-row">
        <div class="avatar-container" (click)="changeAvatar()">
          <img *ngIf="avatarUrl; else initialsTpl" [src]="avatarUrl" class="avatar" alt="avatar">
          <ng-template #initialsTpl>
            <div class="avatar initials">{{ getInitials(profileForm.value.full_name) }}</div>
          </ng-template>
        </div>

        <div>
          <h2 class="title">Profile</h2>
          <span class="sub">Manage account, teams & availability</span>
        </div>
      </div>
    </section>

    <form [formGroup]="profileForm" class="form">

      <!-- BASIC INFO -->
      <section class="section">
        <h3 class="section-title">Your Info</h3>

        <mat-form-field appearance="fill" class="full">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email">
        </mat-form-field>

        <mat-form-field appearance="fill" class="full">
          <mat-label>Full name</mat-label>
          <input matInput formControlName="full_name">
        </mat-form-field>

        <mat-form-field appearance="fill" class="full">
          <mat-label>Timezone</mat-label>
          <input matInput formControlName="timezone">
        </mat-form-field>

        <mat-form-field appearance="fill" class="full">
          <mat-label>Weekly Capacity (Hours)</mat-label>
          <input matInput type="number" formControlName="weekly_capacity_hours">
        </mat-form-field>
      </section>

      <mat-divider></mat-divider>

      <!-- TEAMS SECTION -->
      <section class="section">
        <h3 class="section-title">Your Teams</h3>
        <div class="teams-container">

          <div
            *ngFor="let t of teams"
            class="team-chip"
            [ngClass]="{ default: t.id === user.default_team_id }"
            (click)="selectDefaultTeam(t.id)"
            matTooltip="Click to set as default"
          >
            <span>{{ t.name }}</span>

            <mat-icon *ngIf="t.id === user.default_team_id" class="default-badge">
              workspace_premium
            </mat-icon>
          </div>

          <div *ngIf="teams.length === 0" class="empty-state">
            Not part of any team yet.
          </div>
        </div>
      </section>

      <mat-divider></mat-divider>

      <!-- CALENDAR -->
      <section class="section">
        <h3 class="section-title">Calendar Sync</h3>

        <div class="calendar-row">
          <mat-slide-toggle formControlName="calendar_sync_enabled">
            Sync with Google Calendar
          </mat-slide-toggle>

          <span *ngIf="calendarConnected" class="connected-badge">â€¢ Connected</span>
        </div>

        <div class="calendar-actions">
          <button mat-stroked-button color="primary" *ngIf="!calendarConnected" (click)="connectCalendar()">
            Connect Google Calendar
          </button>

          <button mat-stroked-button color="warn" *ngIf="calendarConnected" (click)="disconnectCalendar()">
            Disconnect
          </button>
        </div>

        <div class="calendar-status" *ngIf="calendarConnected">
          <mat-icon>event</mat-icon>
          Connected as: <strong>{{ calendarId }}</strong>
        </div>
      </section>

      <!-- TIMELINE PREVIEW -->
      <section *ngIf="calendarConnected" class="section">
        <h3 class="section-title">Weekly Activity Timeline</h3>

        <div class="timeline-bar">
          <div
            *ngFor="let slot of busySlots"
            class="bar"
            [style.left.%]="slot.startOffset"
            [style.width.%]="slot.durationPercent"
          ></div>
        </div>

        <div *ngIf="busySlots.length === 0" class="empty-state">No busy time â€” You're fully free ðŸŽ‰</div>
      </section>

      <mat-divider></mat-divider>

      <!-- RULES -->
      <section class="section">
        <h3 class="section-title">Availability Rules</h3>

        <mat-form-field appearance="fill" class="full">
          <mat-label>Available Times (JSON)</mat-label>
          <textarea matInput rows="3" formControlName="available_times"></textarea>
        </mat-form-field>
      </section>

      <button mat-flat-button color="primary" class="full submit" (click)="save()" [disabled]="saving">
        {{ saving ? 'Savingâ€¦' : 'Save changes' }}
      </button>
    </form>
  </mat-card>
</div>
